<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Duckiebot en Línea</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand ms-3" href="#">Duckiebot en Línea</a>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Cámara Original -->
            <div class="col-md-4">
                <div class="card">
                    <img id="imagen_original" src="https://via.placeholder.com/300x200.png?text=Esperando+imagen..."
                        class="card-img-top" alt="Imagen Original" />
                    <div class="card-body">
                        <h5 class="card-title text-center">Cámara Original</h5>
                    </div>
                </div>
            </div>

            <!-- Cámara Integración con YOLO -->
            <div class="col-md-4">
                <div class="card">
                    <video id="video" autoplay muted playsinline></video>
                    <div class="card-body">
                        <h5 class="card-title text-center">Integración con YOLO</h5>
                    </div>
                </div>
            </div>

            <!-- Cámara de Enmascaramiento -->
            <div class="col-md-4">
                <div class="card">
                    <canvas id="canvas_mask" style="border: 1px solid black; width: 100%; height: auto;"></canvas>

                    <div class="card-body">
                        <h5 class="card-title text-center">Enmascaramiento</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    
        <script src="./main.js"></script>

    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.7.0/opencv.js"></script>

    <!-- ROSLIB.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/roslibjs/1.1.0/roslib.min.js"
        integrity="sha512-x2Owc9WayRcRj80Znkau58shVfXN2OIX+gQAlrx6KPugZBKrIC6AwgEWQQCI06p2Q8RB4ilxD+y+1BdNd+1fQA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        const ros = new ROSLIB.Ros({
            url: "ws://zombieduck.local:9001" // Cambia la URL al WebSocket del Duckiebot
        });

        const originalImage = document.getElementById('imagen_original');
        const yoloImage = document.getElementById('imagen_yolo');
        const canvasMask = document.getElementById('canvas_mask');
        const ctx = canvasMask.getContext('2d');

        ros.on("connection", () => console.log("Conectado a ROS"));
        ros.on("error", error => console.error("Error en ROS:", error));
        ros.on("close", () => console.warn("Conexión a ROS cerrada"));

        const subscribeToTopic = (topicName, callback) => {
            const topic = new ROSLIB.Topic({
                ros,
                name: topicName,
                messageType: "sensor_msgs/CompressedImage"
            });

            topic.subscribe(callback);
        };

        const updateImageElement = (message, imgElement) => {
            imgElement.src = "data:image/jpeg;base64," + message.data;
        };

        const processMasking = (message) => {
            console.log("Recibiendo mensaje para enmascarar");
            const img = new Image();
            img.src = "data:image/jpeg;base64," + message.data;

            img.onload = () => {
                console.log("Imagen cargada, dimensiones:", img.width, img.height);
                canvasMask.width = img.width;
                canvasMask.height = img.height;

                // Procesar la imagen
                ctx.drawImage(img, 0, 0);
                const src = cv.imread(canvasMask);
                console.log("Matriz de origen creada: ", src.rows, src.cols);

                const hsv = new cv.Mat();
                const mask = new cv.Mat();
                const result = new cv.Mat();

                try {
                    cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
                    cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);

                    const lowerHSV = new cv.Mat(1, 1, cv.CV_8UC3, [0, 50, 50, 0]);  // Rango inferior
const upperHSV = new cv.Mat(1, 1, cv.CV_8UC3, [179, 255, 255, 0]); // Rango superior

                    cv.inRange(hsv, lowerHSV, upperHSV, mask);
                    console.log("Máscara creada");
                    cv.bitwise_and(src, src, result, mask);

                    cv.imshow(canvasMask, result);
                    console.log("Enmascaramiento aplicado y mostrado en el canvas");

                    lowerHSV.delete();
                    upperHSV.delete();
                } catch (err) {
                    console.error("Error en el procesamiento de enmascaramiento:", err);
                }

                src.delete();
                hsv.delete();
                mask.delete();
                result.delete();
            };

            img.onerror = () => {
                console.error("Error al cargar la imagen para el enmascaramiento");
            };
        };



        // Suscribir a los tópicos
        subscribeToTopic("/zombieduck/camera_node/image/compressed", (msg) => updateImageElement(msg, originalImage));
        subscribeToTopic("/zombieduck/camera_node/image_detected/compressed", (msg) => updateImageElement(msg, yoloImage));
        subscribeToTopic("/zombieduck/camera_node/image/compressed", processMasking);
    </script>
</body>

</html>